# parser

Парсер #-языка, включая разбор xml, csv, json и т.д.

Вход: текст на #-языке.
Выход: добавленные настройки в machine

# Язык

```
##### ключ.формат [аттрибут1, аттрибут2] prepend=true priority=число
текст-в-формате \`\` комментарий
```

Основная идея языка в том, что есть ключи - это как имена функций.
И ключу соответствует не просто тело функции, а серия тел:
* список prepend
* собственное тело own
* список append

Когда вычислительную машину просят вычислить что-то по ключу,
оно идет по очереди по списку [prepend, own, append] и вызывает накопленные тела.

Каждое тело может что-то поделать. При этом считается что результат накапливается в переменной `ctx.r`
Если какая-то функция хочет повлиять на результат, она читает/пишет `ctx.r`.

## форматы
* rb
* xml - по умолчанию, и можно не указывать
* csv
* json
* txt
* yaml

## построение цепочек
По умолчанию если идет ключ, то текст добавляется в список правил этого ключа.
При этом:
* По умолчанию значение добавляется в цепочку append
* Если указано prepend то в цепочку prepend
* Если ключ заканчивается на ! то в собственное значение.

## модификатор записи
* Если ключ заканчивается на = то значение будет присвоено
* Если ключ заканчивается на + то значение будет при-катенировано (что бы это ни значило)

## применение erb
Можно указать для ключа доп. формат `.erb` и тогда значение будет предварительно пропускаться
через процессор erb.

Можно указать ключ erb и тогда все тело будет на этапе парсинга пропущено через erb
и пропарсено повторно.

## include
Можно указать ключ `include mask` и тогда все файлы по маске `mask` будут include-ны.

# Методы языка
При выполнении форматов .rb и .erb можно обращаться к вычислительной машине с помощью вызова `ctx.machine`.

# Методы

## machine=
Привязывает машину к парсеру. Парсер в работе parse будет добавлять правила в эту машину.

## parse: text -> updated_machine
Производит разбор #-текста, добавляет правила в machine.

# ideas
- вытащить форматы наружу, чтобы пользователь мог их подключать.
- уметь задавать формат по умолчанию (например сейчас xml а требуется ini).
- понять, может стоит машину передавать как аргумент в parse.
а не держать привязанной к экземпляру.

# todo
- описать апи
- описать язык
